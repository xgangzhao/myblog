---
title: Linux 中断处理机制梳理
date: 2025-11-30 14:41:31
tags: [Linux, Interrupt, Driver]
---


中断 (Interrupt) 是处理器接收到的一个信号，指示需要立即暂停当前执行的任务，转而去处理一个特定事件。在 Linux 中，它是实现 I/O、计时器和进程调度的基础。

## 核心概念与分类

### 中断类型 (Type)

- 硬件中断 (Hardware Interrupts): 由外部设备（如键盘、网卡、磁盘）通过中断控制器（如 APIC）发出的信号。它们是异步的。

- 软件中断 (Software Interrupts/Exceptions): 由 CPU 自身在执行指令时产生，通常是同步的。

    - 异常 (Exceptions): 处理器执行指令的同步事件，例如除零错误、页错误（缺页）。

    - 系统调用 (System Calls): 一种特殊的软件中断，用于从用户空间切换到内核空间。

### 中断描述符表 (IDT, Interrupt Descriptor Table)

IDT 是内核维护的一个数据结构，它将每个中断或异常的向量号（0-255）映射到对应的内核处理函数（中断服务程序，ISR）的入口地址。当 CPU 接收到一个中断信号时，会通过 IDT 找到并跳转到正确的处理代码。

## 中断处理流程

一个硬件中断从设备发生到内核执行处理程序的完整流程可以概括为以下步骤：

1. 设备发起中断： 硬件设备（如网卡）完成工作，向中断控制器（如 APIC）发送电信号。

2. 中断控制器通知 CPU： 中断控制器将信号发送给 CPU 的一个或多个核心。

3. CPU 响应：

    - CPU 停止当前执行的代码。

    - 保存当前执行状态（寄存器、程序计数器等）到内核堆栈。

    - CPU 硬件根据中断向量号，通过 IDT 查找对应的中断门描述符。

    - CPU 切换到内核模式。

4. 汇编层面的初步处理 (Entry Code)： 执行 IDT 中指向的汇编代码，这是通用的入口代码。

    - 进一步保存所有通用寄存器。

    - 设置内核堆栈。

    - 跳转到 C 语言编写的通用中断处理程序 do_IRQ（或类似的架构特定函数）。

5. C 语言中断处理 (Top-Half)：

    - do_IRQ 屏蔽该中断线，防止重入。

    - 查找并调用注册到该中断线的中断服务程序 (ISR)。

    - ISR 快速执行必要的、耗时短的关键任务（如确认中断、清除硬件状态）。

    - 如果需要进行耗时任务，ISR 安排底半部工作。

6. 退出中断：

    - ISR 返回，do_IRQ 发送 EOI (End of Interrupt) 信号给中断控制器。

    - 检查并执行底半部任务。

    - 汇编代码恢复所有寄存器状态。

    - CPU 返回到被中断的任务继续执行。

## 中断的上下半部机制 (Top-Half & Bottom-Half)

为了保证中断响应的低延迟和高效率，Linux 将中断处理逻辑分为两个部分：

1. 上半部 (Top-Half)

    执行环境： 处于中断上下文中，禁止或屏蔽了部分甚至所有中断。

    特性： 运行速度极快，不能睡眠或调用任何可能阻塞的函数。

    任务： 接收中断信号、清除硬件状态、读取关键数据、调度底半部。

    目标： 尽快完成并释放 CPU，恢复中断响应能力。

2. 底半部 (Bottom-Half)

    执行环境： 一些底半部机制（软中断和tasklet）是在软中断上下文中执行的，严格来说也是在中断上下文中。但它们不会立即执行，而是在硬中断处理完之后，由内核调度执行。（PS：这点比较迷惑，不太清晰）

    特性： 允许运行时间较长，可以进行复杂操作（如网络协议栈处理、磁盘 I/O 完成）。

    任务： 执行大部分实际数据处理和逻辑。

    目标： 将耗时工作从上半部剥离，减少上半部对系统中断延迟的影响。

### 三种主要的底半部实现机制

|机制名称|调度方式|执行上下文|适用场景|
|---|---|---|---|
|Softirqs (软中断)|由内核在特定时间点（如中断返回前、内核线程中）触发|中断上下文或软中断上下文（非抢占）|适用于高性能、对延迟要求极高的场景（如网络、计时器）。数量固定|
|Tasklets (任务队列)|基于 Softirqs 实现|软中断上下文|动态创建，适用于非网络和计时器等场景，同一 Tasklet 不会并发执行|
|Workqueues (工作队列)|通过专用的内核线程执行|进程上下文|最灵活，可以睡眠、阻塞，适用于需要进行 I/O 或耗时操作的场景|

